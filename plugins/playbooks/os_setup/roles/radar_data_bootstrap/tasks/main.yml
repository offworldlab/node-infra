---
# Playbook: radar_data_bootstrap
# Version: 0.1.1
# 
# Purpose: Bootstrap /data/blah2/ with application files from blah2-arm repo
# 
# This populates the persistent /data partition with:
#   - docker-compose.yml
#   - Configuration files
#   - Scripts (sdrplay-restart.sh)
#   - Web assets (HTML, nginx config)
#   - Test data (optional)
#
# Files are fetched from blah2-arm repo at a pinned commit/tag

# Variables to set in defaults:
# blah2_repo_url: "https://github.com/offworldlab/blah2-arm.git"
# blah2_version: "abc123def"  # commit hash or tag

# 1. Create base directory structure
- name: Create /data/blah2 directory structure
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /data/blah2
    - /data/blah2/config
    - /data/blah2/script
    - /data/blah2/save
    - /data/blah2/test

# 2. Clone blah2-arm at pinned version
- name: Clone blah2-arm repository
  git:
    repo: "{{ blah2_repo_url }}"
    dest: /tmp/blah2-arm
    version: "{{ blah2_version }}"

# 3. Copy files to /data/blah2/
- name: Copy docker-compose.yml
  copy:
    src: /tmp/blah2-arm/deploy/docker-compose.prod.yml
    dest: /data/blah2/docker-compose.yml
    mode: '0644'
    owner: root
    group: root
    remote_src: yes

- name: Copy config directory
  copy:
    src: /tmp/blah2-arm/config/
    dest: /data/blah2/config/
    owner: root
    group: root
    remote_src: yes

- name: Fix config directory permissions
  file:
    path: /data/blah2/config
    state: directory
    mode: '0755'
    owner: root
    group: root
    recurse: yes

- name: Copy sdrplay-restart.sh script
  copy:
    src: /tmp/blah2-arm/sdrplay-restart.sh
    dest: /data/blah2/script/sdrplay-restart.sh
    mode: '0755'
    owner: root
    group: root
    remote_src: yes

- name: Copy test directory #Optional could remove?
  copy:
    src: /tmp/blah2-arm/test/
    dest: /data/blah2/test/
    owner: root
    group: root
    remote_src: yes
  ignore_errors: yes

- name: Fix test directory permissions #Optional could remove?
  file:
    path: /data/blah2/test
    state: directory
    mode: '0755'
    owner: root
    group: root
    recurse: yes
  ignore_errors: yes

# 4. Create systemd service for first-boot container startup, retry untill sucessful
- name: Create blah2 first-boot systemd service
  copy:
    dest: /etc/systemd/system/blah2-firstboot.service
    mode: '0644'
    owner: root
    group: root
    content: |
      [Unit]
      Description=Start blah2 containers on first boot
      After=docker.service network-online.target
      Requires=docker.service
      ConditionPathExists=!/data/blah2/.started

      [Service]
      Type=oneshot
      WorkingDirectory=/data/blah2
      ExecStart=/usr/bin/docker compose pull
      ExecStart=/usr/bin/docker compose up -d
      ExecStartPost=/usr/bin/touch /data/blah2/.started
      Restart=on-failure
      RestartSec=60
      StartLimitBurst=0

      [Install]
      WantedBy=multi-user.target

- name: Enable blah2 first-boot service
  file:
    src: /etc/systemd/system/blah2-firstboot.service
    dest: /etc/systemd/system/multi-user.target.wants/blah2-firstboot.service
    state: link

# 5. Cleanup
- name: Remove temporary clone
  file:
    path: /tmp/blah2-arm
    state: absent